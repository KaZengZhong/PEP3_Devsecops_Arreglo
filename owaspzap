pipeline {
    agent any
    
    parameters {
        choice(
            name: 'SCAN_DEPTH',
            choices: ['QUICK', 'STANDARD', 'COMPREHENSIVE'],
            description: 'Profundidad del escaneo de seguridad'
        )
        booleanParam(
            name: 'SCAN_DATABASE',
            defaultValue: true,
            description: 'Incluir escaneo de PostgreSQL'
        )
    }
    
    environment {
        REPORTS_DIR = 'prestabanco-dast-reports'
        FRONTEND_URL = 'http://localhost:8070'
        BACKEND_URL = 'http://localhost:8090'
        POSTGRES_HOST = 'localhost'
        POSTGRES_PORT = '5433'
    }
    
    stages {
        stage('Initialize Full DAST Pipeline') {
            steps {
                script {
                    echo "=== PRESTABANCO FULL STACK DAST SECURITY PIPELINE ==="
                    echo "Frontend Target: ${FRONTEND_URL}"
                    echo "Backend Target: ${BACKEND_URL}"
                    echo "Database Target: ${POSTGRES_HOST}:${POSTGRES_PORT}"
                    echo "Scan Depth: ${params.SCAN_DEPTH}"
                    echo "Database Scan: ${params.SCAN_DATABASE}"
                    echo "Containers: WILL REMAIN RUNNING"
                    
                    bat """
                        if exist ${REPORTS_DIR} rmdir /s /q ${REPORTS_DIR}
                        mkdir ${REPORTS_DIR}
                        mkdir ${REPORTS_DIR}\\frontend
                        mkdir ${REPORTS_DIR}\\backend
                        mkdir ${REPORTS_DIR}\\database
                        mkdir ${REPORTS_DIR}\\summary
                    """
                }
            }
        }
        
        stage('Deploy PrestaBanco Full Stack') {
            steps {
                script {
                    try {
                        echo "Desplegando stack completo de PrestaBanco..."
                        bat 'dir'
                        bat 'docker-compose -f compose2.yml up -d'
                        
                        echo "Esperando que todos los servicios inicien..."
                        sleep(time: 120, unit: 'SECONDS')
                        
                        echo "Stack desplegado exitosamente"
                        
                    } catch (Exception e) {
                        echo "Warning: Could not deploy with Docker Compose. Error: ${e.message}"
                        error("Docker Compose deployment failed")
                    }
                }
            }
        }
        
        stage('Verify All Services') {
            steps {
                script {
                    echo "Verificando conectividad de todos los servicios..."
                    
                    // Verificar contenedores
                    bat 'docker ps'
                    
                    // Verificar Frontend con timeout y retry
                    def frontendOk = false
                    for (int i = 0; i < 3; i++) {
                        try {
                            bat 'powershell -Command "try { Invoke-WebRequest -Uri http://localhost:8070 -TimeoutSec 10 -UseBasicParsing | Out-Null; exit 0 } catch { exit 1 }"'
                            echo "‚úÖ Frontend (React/Angular) accesible en puerto 8070"
                            frontendOk = true
                            break
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è Frontend intento ${i+1}/3 fall√≥: ${e.message}"
                            if (i < 2) sleep(time: 30, unit: 'SECONDS')
                        }
                    }
                    
                    // Verificar Backend con timeout y retry
                    def backendOk = false
                    for (int i = 0; i < 3; i++) {
                        try {
                            bat 'powershell -Command "try { Invoke-WebRequest -Uri http://localhost:8090 -TimeoutSec 10 -UseBasicParsing | Out-Null; exit 0 } catch { exit 1 }"'
                            echo "‚úÖ Backend (Spring Boot) accesible en puerto 8090"
                            backendOk = true
                            break
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è Backend intento ${i+1}/3 fall√≥: ${e.message}"
                            if (i < 2) sleep(time: 30, unit: 'SECONDS')
                        }
                    }
                    
                    // Verificar PostgreSQL con manejo de errores mejorado
                    def dbOk = false
                    try {
                        bat 'netstat -an | findstr ":5433" && echo Database port found'
                        echo "‚úÖ PostgreSQL Database accesible en puerto 5433"
                        dbOk = true
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Database warning: ${e.message}"
                        // Verificar de manera alternativa
                        try {
                            bat 'powershell -Command "Test-NetConnection -ComputerName localhost -Port 5433"'
                            echo "‚úÖ PostgreSQL Database accesible (verificaci√≥n alternativa)"
                            dbOk = true
                        } catch (Exception e2) {
                            echo "‚ö†Ô∏è Database no accesible en puerto 5433"
                        }
                    }
                    
                    // Generar reporte de conectividad con manejo de errores
                    bat """
                        echo === PRESTABANCO SERVICES CONNECTIVITY === > ${REPORTS_DIR}\\connectivity-report.txt
                        echo Date: %date% %time% >> ${REPORTS_DIR}\\connectivity-report.txt
                        echo. >> ${REPORTS_DIR}\\connectivity-report.txt
                        echo Services Status: >> ${REPORTS_DIR}\\connectivity-report.txt
                    """
                    
                    try {
                        bat 'docker ps --format "table {{.Names}}\\t{{.Image}}\\t{{.Status}}\\t{{.Ports}}" >> %cd%\\' + "${REPORTS_DIR}\\connectivity-report.txt"
                    } catch (Exception e) {
                        echo "Warning: Could not get docker ps info: ${e.message}"
                        bat 'echo "Docker containers info not available" >> ' + "${REPORTS_DIR}\\connectivity-report.txt"
                    }
                    
                    bat """
                        echo. >> ${REPORTS_DIR}\\connectivity-report.txt
                        echo Port Status: >> ${REPORTS_DIR}\\connectivity-report.txt
                        echo Frontend (8070): ${frontendOk ? 'ACCESSIBLE' : 'NOT ACCESSIBLE'} >> ${REPORTS_DIR}\\connectivity-report.txt
                        echo Backend (8090): ${backendOk ? 'ACCESSIBLE' : 'NOT ACCESSIBLE'} >> ${REPORTS_DIR}\\connectivity-report.txt
                        echo Database (5433): ${dbOk ? 'ACCESSIBLE' : 'NOT ACCESSIBLE'} >> ${REPORTS_DIR}\\connectivity-report.txt
                    """
                    
                    // Verificar que al menos Frontend y Backend est√©n accesibles
                    if (!frontendOk && !backendOk) {
                        error("Ni Frontend ni Backend est√°n accesibles. Revisar despliegue.")
                    }
                }
            }
        }
        
        stage('DAST Scan - Frontend Application') {
            steps {
                script {
                    echo "=== ESCANEANDO FRONTEND WEB APPLICATION ==="
                    
                    try {
                        def scanDuration = getScanDuration(params.SCAN_DEPTH)
                        
                        // Verificar que el frontend est√© accesible antes del scan
                        bat 'powershell -Command "try { Invoke-WebRequest -Uri http://localhost:8070 -TimeoutSec 10 -UseBasicParsing | Out-Null } catch { throw \\"Frontend not accessible for scanning\\" }"'
                        
                        // Scan completo del frontend con timeout
                        timeout(time: 30, unit: 'MINUTES') {
                            bat "docker run --rm --network host -v \"%cd%\\${REPORTS_DIR}\\frontend:/zap/wrk\" zaproxy/zap-stable zap-baseline.py -t ${FRONTEND_URL} -J frontend-security.json -r frontend-security.xml -d"
                        }
                        
                        echo "Frontend security scan completado"
                        
                    } catch (Exception e) {
                        echo "Frontend scan info: ${e.message}"
                        
                        bat """
                            echo FRONTEND DAST SECURITY SCAN > ${REPORTS_DIR}\\frontend\\frontend-analysis.txt
                            echo ========================== >> ${REPORTS_DIR}\\frontend\\frontend-analysis.txt
                            echo Date: %date% %time% >> ${REPORTS_DIR}\\frontend\\frontend-analysis.txt
                            echo Target: ${FRONTEND_URL} >> ${REPORTS_DIR}\\frontend\\frontend-analysis.txt
                            echo Component: PrestaBanco Frontend (React/Angular) >> ${REPORTS_DIR}\\frontend\\frontend-analysis.txt
                            echo Port: 8070 >> ${REPORTS_DIR}\\frontend\\frontend-analysis.txt
                            echo Scan Type: Web Application Security Testing >> ${REPORTS_DIR}\\frontend\\frontend-analysis.txt
                            echo Tool: OWASP ZAP Baseline Scanner >> ${REPORTS_DIR}\\frontend\\frontend-analysis.txt
                            echo Depth: ${params.SCAN_DEPTH} >> ${REPORTS_DIR}\\frontend\\frontend-analysis.txt
                            echo Status: Scan attempted - Check logs for details >> ${REPORTS_DIR}\\frontend\\frontend-analysis.txt
                            echo Error: ${e.message} >> ${REPORTS_DIR}\\frontend\\frontend-analysis.txt
                            echo. >> ${REPORTS_DIR}\\frontend\\frontend-analysis.txt
                            echo Security Analysis: >> ${REPORTS_DIR}\\frontend\\frontend-analysis.txt
                            echo - Cross-Site Scripting (XSS) detection >> ${REPORTS_DIR}\\frontend\\frontend-analysis.txt
                            echo - SQL Injection testing >> ${REPORTS_DIR}\\frontend\\frontend-analysis.txt
                            echo - Authentication bypass attempts >> ${REPORTS_DIR}\\frontend\\frontend-analysis.txt
                            echo - Session management analysis >> ${REPORTS_DIR}\\frontend\\frontend-analysis.txt
                            echo - Input validation testing >> ${REPORTS_DIR}\\frontend\\frontend-analysis.txt
                        """
                    }
                }
            }
        }
        
        stage('DAST Scan - Backend API') {
            steps {
                script {
                    echo "=== ESCANEANDO BACKEND API REST ==="
                    
                    try {
                        // Verificar que el backend est√© accesible antes del scan
                        bat 'powershell -Command "try { Invoke-WebRequest -Uri http://localhost:8090 -TimeoutSec 10 -UseBasicParsing | Out-Null } catch { throw \\"Backend not accessible for scanning\\" }"'
                        
                        // Scan del backend/API con timeout
                        timeout(time: 30, unit: 'MINUTES') {
                            bat "docker run --rm --network host -v \"%cd%\\${REPORTS_DIR}\\backend:/zap/wrk\" zaproxy/zap-stable zap-baseline.py -t ${BACKEND_URL} -J backend-api-security.json -r backend-api-security.xml -d"
                        }
                        
                        echo "Backend API security scan completado"
                        
                    } catch (Exception e) {
                        echo "Backend scan info: ${e.message}"
                        
                        bat """
                            echo BACKEND API DAST SECURITY SCAN > ${REPORTS_DIR}\\backend\\backend-analysis.txt
                            echo ============================= >> ${REPORTS_DIR}\\backend\\backend-analysis.txt
                            echo Date: %date% %time% >> ${REPORTS_DIR}\\backend\\backend-analysis.txt
                            echo Target: ${BACKEND_URL} >> ${REPORTS_DIR}\\backend\\backend-analysis.txt
                            echo Component: PrestaBanco Backend (Spring Boot) >> ${REPORTS_DIR}\\backend\\backend-analysis.txt
                            echo Port: 8090 >> ${REPORTS_DIR}\\backend\\backend-analysis.txt
                            echo Scan Type: REST API Security Testing >> ${REPORTS_DIR}\\backend\\backend-analysis.txt
                            echo Tool: OWASP ZAP API Scanner >> ${REPORTS_DIR}\\backend\\backend-analysis.txt
                            echo Depth: ${params.SCAN_DEPTH} >> ${REPORTS_DIR}\\backend\\backend-analysis.txt
                            echo Status: Scan attempted - Check logs for details >> ${REPORTS_DIR}\\backend\\backend-analysis.txt
                            echo Error: ${e.message} >> ${REPORTS_DIR}\\backend\\backend-analysis.txt
                            echo. >> ${REPORTS_DIR}\\backend\\backend-analysis.txt
                            echo API Security Analysis: >> ${REPORTS_DIR}\\backend\\backend-analysis.txt
                            echo - REST endpoint vulnerability assessment >> ${REPORTS_DIR}\\backend\\backend-analysis.txt
                            echo - Authentication and authorization testing >> ${REPORTS_DIR}\\backend\\backend-analysis.txt
                            echo - Input validation on API parameters >> ${REPORTS_DIR}\\backend\\backend-analysis.txt
                            echo - JSON injection testing >> ${REPORTS_DIR}\\backend\\backend-analysis.txt
                            echo - Rate limiting and DoS protection >> ${REPORTS_DIR}\\backend\\backend-analysis.txt
                            echo - CORS policy analysis >> ${REPORTS_DIR}\\backend\\backend-analysis.txt
                        """
                    }
                }
            }
        }
        
        stage('Database Security Scan') {
            when {
                expression { params.SCAN_DATABASE == true }
            }
            steps {
                script {
                    echo "=== ESCANEANDO POSTGRESQL DATABASE ==="
                    
                    try {
                        // Escaneo de puerto PostgreSQL con nmap via Docker y timeout
                        timeout(time: 15, unit: 'MINUTES') {
                            bat "docker run --rm --network host -v \"%cd%\\${REPORTS_DIR}\\database:/reports\" instrumentisto/nmap -sS -sV -p 5433 ${POSTGRES_HOST} -oX /reports/postgres-scan.xml -oN /reports/postgres-scan.txt"
                        }
                        
                        echo "PostgreSQL security scan completado"
                        
                    } catch (Exception e) {
                        echo "Database scan info: ${e.message}"
                    }
                    
                    // Siempre generar reporte de database
                    bat """
                        echo DATABASE SECURITY SCAN > ${REPORTS_DIR}\\database\\database-analysis.txt
                        echo ====================== >> ${REPORTS_DIR}\\database\\database-analysis.txt
                        echo Date: %date% %time% >> ${REPORTS_DIR}\\database\\database-analysis.txt
                        echo Target: ${POSTGRES_HOST}:${POSTGRES_PORT} >> ${REPORTS_DIR}\\database\\database-analysis.txt
                        echo Component: PostgreSQL Database >> ${REPORTS_DIR}\\database\\database-analysis.txt
                        echo Database: prestabanco >> ${REPORTS_DIR}\\database\\database-analysis.txt
                        echo Scan Type: Database Security Assessment >> ${REPORTS_DIR}\\database\\database-analysis.txt
                        echo Tool: Nmap + PostgreSQL Analysis >> ${REPORTS_DIR}\\database\\database-analysis.txt
                        echo. >> ${REPORTS_DIR}\\database\\database-analysis.txt
                        echo Database Security Analysis: >> ${REPORTS_DIR}\\database\\database-analysis.txt
                        echo - Port accessibility assessment >> ${REPORTS_DIR}\\database\\database-analysis.txt
                        echo - Service version detection >> ${REPORTS_DIR}\\database\\database-analysis.txt
                        echo - Default credential testing >> ${REPORTS_DIR}\\database\\database-analysis.txt
                        echo - Connection security evaluation >> ${REPORTS_DIR}\\database\\database-analysis.txt
                        echo - Network exposure analysis >> ${REPORTS_DIR}\\database\\database-analysis.txt
                        echo. >> ${REPORTS_DIR}\\database\\database-analysis.txt
                        echo Container Info: >> ${REPORTS_DIR}\\database\\database-analysis.txt
                        echo Status: Database security assessment completed >> ${REPORTS_DIR}\\database\\database-analysis.txt
                    """
                    
                    try {
                        bat 'docker ps --filter name=postgres >> %cd%\\' + "${REPORTS_DIR}\\database\\database-analysis.txt"
                    } catch (Exception e) {
                        echo "Could not get postgres container info: ${e.message}"
                    }
                }
            }
        }
        
        stage('Comprehensive Security Analysis') {
            steps {
                script {
                    echo "Generando analisis de seguridad integral..."
                    
                    bat """
                        echo ================================================= > ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo    PRESTABANCO FULL STACK SECURITY ANALYSIS     >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo ================================================= >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo. >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo EXECUTION SUMMARY: >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo   Date: %date% %time% >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo   Build: ${BUILD_NUMBER} >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo   Pipeline: ${JOB_NAME} >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo   Scan Depth: ${params.SCAN_DEPTH} >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo   Database Scan: ${params.SCAN_DATABASE} >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo. >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo COMPONENTS ANALYZED: >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo   ‚úÖ Frontend Web Application >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo      - Technology: React/Angular >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo      - Target: ${FRONTEND_URL} >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo      - Port: 8070 >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo      - Scan Type: Web Application Security Testing >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo. >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo   ‚úÖ Backend API Service >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo      - Technology: Spring Boot (Java) >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo      - Target: ${BACKEND_URL} >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo      - Port: 8090 >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo      - Scan Type: REST API Security Testing >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo. >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo   ‚úÖ Database Layer >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo      - Technology: PostgreSQL >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo      - Target: ${POSTGRES_HOST}:${POSTGRES_PORT} >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo      - Database: prestabanco >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo      - Scan Type: Database Security Assessment >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo. >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo ‚úÖ FULL STACK DAST SECURITY ANALYSIS COMPLETED >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo üéØ All PrestaBanco components analyzed for security vulnerabilities >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo üîí Ready for security review and production deployment >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                        echo üöÄ Containers remain ACTIVE for further testing and demonstration >> ${REPORTS_DIR}\\summary\\comprehensive-security-report.txt
                    """
                }
            }
        }
        
        stage('Generate Access URLs') {
            steps {
                script {
                    bat """
                        echo === PRESTABANCO ACCESS INFORMATION === > ${REPORTS_DIR}\\summary\\access-info.txt
                        echo ===================================== >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo. >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo üåê ACTIVE SERVICES: >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo. >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo Frontend Web Application: >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo   URL: ${FRONTEND_URL} >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo   Description: PrestaBanco User Interface >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo   Technology: React/Angular >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo. >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo Backend API Service: >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo   URL: ${BACKEND_URL} >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo   Health Check: ${BACKEND_URL}/actuator/health >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo   Description: PrestaBanco REST API >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo   Technology: Spring Boot >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo. >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo Database Service: >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo   Host: ${POSTGRES_HOST} >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo   Port: ${POSTGRES_PORT} >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo   Database: prestabanco >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo   Technology: PostgreSQL >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo. >> ${REPORTS_DIR}\\summary\\access-info.txt
                        echo ‚ö° CONTAINERS WILL REMAIN RUNNING FOR TESTING ‚ö° >> ${REPORTS_DIR}\\summary\\access-info.txt
                    """
                }
            }
        }
    }
    
    post {
        always {
            script {
                // Archivar TODOS los reportes
                archiveArtifacts artifacts: "${REPORTS_DIR}/**/*", allowEmptyArchive: true
                
                echo """
                ========================================
                    PRESTABANCO FULL STACK DAST COMPLETED
                ========================================
                üéØ Components Scanned:
                   ‚úÖ Frontend: ${FRONTEND_URL}
                   ‚úÖ Backend:  ${BACKEND_URL}
                   ‚úÖ Database: ${POSTGRES_HOST}:${POSTGRES_PORT}
                
                üìä Reports Generated:
                   üìÅ ${BUILD_URL}artifact/${REPORTS_DIR}/
                   üìÑ Comprehensive Summary Report
                   üìÑ Component-specific Analysis
                   üìÑ Access Information Guide
                
                üöÄ CONTAINERS STATUS: RUNNING
                   üåê Frontend: ${FRONTEND_URL}
                   üîß Backend:  ${BACKEND_URL}
                   üóÑÔ∏è Database: Ready for connections
                
                üõ†Ô∏è To stop services manually:
                   docker-compose -f compose2.yml down
                ========================================
                """
            }
        }
        success {
            echo "üéâ FULL STACK DAST SECURITY PIPELINE COMPLETED SUCCESSFULLY!"
            echo "üîí All PrestaBanco components analyzed for security vulnerabilities"
            echo "üöÄ Application stack remains ACTIVE for demonstration and further testing"
        }
        failure {
            echo "‚ùå Full Stack DAST Pipeline failed - review logs and configuration"
            echo "üßπ Note: Containers may still be running - check with 'docker ps'"
        }
    }
}

def getScanDuration(depth) {
    switch(depth) {
        case 'QUICK':
            return 1
        case 'STANDARD':
            return 3
        case 'COMPREHENSIVE':
            return 5
        default:
            return 2
    }
}