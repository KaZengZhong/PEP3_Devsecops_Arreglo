pipeline {
    agent any
    
    parameters {
        choice(
            name: 'SCAN_DEPTH',
            choices: ['QUICK', 'STANDARD', 'COMPREHENSIVE'],
            description: 'Profundidad del escaneo de seguridad'
        )
    }
    
    environment {
        REPORTS_DIR = 'security-reports'
        FRONTEND_URL = 'http://localhost:8070'
        BACKEND_URL = 'http://localhost:8090'
    }
    
    stages {
        stage('Initialize') {
            steps {
                script {
                    echo "=== PRESTABANCO SECURITY SCAN ==="
                    
                    bat """
                        if exist ${REPORTS_DIR} rmdir /s /q ${REPORTS_DIR}
                        mkdir ${REPORTS_DIR}
                        mkdir ${REPORTS_DIR}\\assets
                    """
                }
            }
        }
        
        stage('Deploy Services') {
            steps {
                script {
                    bat 'docker-compose -f compose2.yml down || echo "No containers"'
                    bat 'docker-compose -f compose2.yml up -d'
                    sleep(time: 90, unit: 'SECONDS')
                }
            }
        }
        
        stage('Verify Services') {
            steps {
                script {
                    def frontendOk = false
                    def backendOk = false
                    
                    echo "Verificando contenedores Docker..."
                    bat 'docker ps --format "table {{.Names}}\\t{{.Ports}}\\t{{.Status}}"'
                    
                    // Frontend
                    try {
                        bat 'powershell -Command "Invoke-WebRequest -Uri http://localhost:8070 -TimeoutSec 10 -UseBasicParsing | Out-Null"'
                        frontendOk = true
                        echo "Frontend: OK"
                    } catch (Exception e) {
                        echo "Frontend: FAILED"
                    }
                    
                    // Backend
                    try {
                        bat 'powershell -Command "Test-NetConnection -ComputerName localhost -Port 8090 -WarningAction SilentlyContinue"'
                        backendOk = true
                        echo "Backend: OK (puerto responde)"
                    } catch (Exception e) {
                        echo "Backend: FAILED"
                    }
                    
                    env.FRONTEND_OK = frontendOk.toString()
                    env.BACKEND_OK = backendOk.toString()
                }
            }
        }
        
        stage('Create Enhanced CSS') {
            steps {
                script {
                    echo "Creando CSS mejorado para reportes..."
                    
                    bat """
                        echo /* Enhanced Security Report Styles */ > ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo * { box-sizing: border-box; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo body { >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     background: linear-gradient(135deg, #667eea 0%%, #764ba2 100%%); >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     margin: 0; padding: 20px; min-height: 100vh; line-height: 1.6; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .container { >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     max-width: 1400px; margin: 0 auto; background: white; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     border-radius: 15px; box-shadow: 0 25px 50px rgba(0,0,0,0.15); >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     overflow: hidden; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .header { >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     background: linear-gradient(45deg, #1e3c72, #2a5298); >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     color: white; padding: 40px; text-align: center; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .header h1 { margin: 0; font-size: 2.5em; font-weight: 300; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .header p { margin: 10px 0 0 0; opacity: 0.9; font-size: 1.1em; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .summary-section { >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     padding: 30px; background: #f8f9fa; border-bottom: 1px solid #dee2e6; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .card { >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     background: white; padding: 25px; border-radius: 12px; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.08); >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     border-left: 5px solid; transition: transform 0.3s ease; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .card:hover { transform: translateY(-5px); } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .card-high { border-color: #dc3545; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .card-medium { border-color: #fd7e14; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .card-low { border-color: #ffc107; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .card-info { border-color: #17a2b8; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .card-safe { border-color: #28a745; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .card h3 { margin: 0 0 10px 0; font-size: 1.8em; font-weight: bold; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .card p { margin: 0; color: #6c757d; font-size: 1.1em; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .alerts-section { padding: 40px; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .alert-item { >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     background: white; margin: 25px 0; padding: 30px; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     border-left: 6px solid; position: relative; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .alert-high { border-color: #dc3545; background: #fff5f5; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .alert-medium { border-color: #fd7e14; background: #fffaf0; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .alert-low { border-color: #ffc107; background: #fffdf0; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .alert-info { border-color: #17a2b8; background: #f0fcff; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .alert-title { >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     font-size: 1.4em; font-weight: bold; margin: 0 0 15px 0; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     display: flex; align-items: center; gap: 10px; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .risk-badge { >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     padding: 5px 12px; border-radius: 20px; font-size: 0.8em; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     font-weight: bold; text-transform: uppercase; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .risk-high { background: #dc3545; color: white; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .risk-medium { background: #fd7e14; color: white; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .risk-low { background: #ffc107; color: #212529; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .risk-info { background: #17a2b8; color: white; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .alert-details { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .detail-item { >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     background: rgba(255,255,255,0.8); padding: 15px; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     border-radius: 8px; border: 1px solid #e9ecef; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .detail-label { font-weight: bold; color: #495057; margin-bottom: 5px; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .detail-value { color: #212529; word-break: break-all; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .solution-box { >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     background: #e8f5e8; border: 1px solid #28a745; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     border-radius: 8px; padding: 20px; margin: 20px 0; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .solution-title { >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     color: #28a745; font-weight: bold; margin-bottom: 10px; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     font-size: 1.1em; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .instances-count { >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     position: absolute; top: 15px; right: 15px; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     background: #6c757d; color: white; padding: 5px 10px; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     border-radius: 15px; font-size: 0.9em; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .reference-links { margin-top: 15px; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .reference-links a { >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     color: #007bff; text-decoration: none; margin-right: 15px; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     padding: 5px 10px; background: #f8f9fa; border-radius: 5px; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     font-size: 0.9em; display: inline-block; margin-bottom: 5px; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .reference-links a:hover { background: #e9ecef; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .nav-button { >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     display: inline-block; padding: 12px 25px; margin: 10px; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     background: #007bff; color: white; text-decoration: none; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     border-radius: 25px; transition: all 0.3s ease; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     font-weight: 500; >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo .nav-button:hover { >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     background: #0056b3; transform: translateY(-2px); >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     box-shadow: 0 5px 15px rgba(0,123,255,0.3); >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo @media (max-width: 768px) { >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     .alert-details { grid-template-columns: 1fr; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     .summary-cards { grid-template-columns: 1fr; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo     .container { margin: 10px; } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                        echo } >> ${REPORTS_DIR}\\assets\\enhanced-style.css
                    """
                }
            }
        }
        
        stage('Enhanced Security Scan') {
            steps {
                script {
                    echo "Ejecutando scans y generando reportes mejorados..."
                    
                    // Frontend Scan
                    if (env.FRONTEND_OK == 'true') {
                        echo "Escaneando Frontend..."
                        try {
                            timeout(time: 20, unit: 'MINUTES') {
                                // Generar reporte XML (m√°s completo)
                                bat "docker run --rm --network host -v \"%cd%\\${REPORTS_DIR}:/zap/wrk\" zaproxy/zap-stable zap-baseline.py -t ${FRONTEND_URL} -x frontend-raw.xml"
                            }
                            
                            // Convertir XML a HTML mejorado
                            bat """
                                powershell -Command "
                                [xml]\\$xml = Get-Content '${REPORTS_DIR}\\frontend-raw.xml'
                                \\$alerts = \\$xml.OWASPZAPReport.site.alerts.alertitem
                                \\$summary = @{}
                                foreach(\\$alert in \\$alerts) {
                                    \\$risk = \\$alert.riskdesc -split ' ' | Select-Object -First 1
                                    if(\\$summary.ContainsKey(\\$risk)) { \\$summary[\\$risk]++ } else { \\$summary[\\$risk] = 1 }
                                }
                                
                                \\$html = @'
<!DOCTYPE html>
<html lang='es'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Frontend Security Report - PRESTABANCO</title>
    <link rel='stylesheet' href='assets/enhanced-style.css'>
</head>
<body>
    <div class='container'>
        <div class='header'>
            <h1>üåê Frontend Security Report</h1>
            <p>Target: ${FRONTEND_URL}</p>
            <p>Generated: '+ (Get-Date).ToString('yyyy-MM-dd HH:mm:ss') +'</p>
            <a href='dashboard.html' class='nav-button'>‚Üê Volver al Dashboard</a>
        </div>
        
        <div class='summary-section'>
            <h2>üìä Resumen de Alertas</h2>
            <div class='summary-cards'>
'@
                                
                                if(\\$summary['High']) { \\$html += '<div class=\"card card-high\"><h3>' + \\$summary['High'] + '</h3><p>Riesgo Alto</p></div>' }
                                else { \\$html += '<div class=\"card card-safe\"><h3>0</h3><p>Riesgo Alto</p></div>' }
                                
                                if(\\$summary['Medium']) { \\$html += '<div class=\"card card-medium\"><h3>' + \\$summary['Medium'] + '</h3><p>Riesgo Medio</p></div>' }
                                else { \\$html += '<div class=\"card card-safe\"><h3>0</h3><p>Riesgo Medio</p></div>' }
                                
                                if(\\$summary['Low']) { \\$html += '<div class=\"card card-low\"><h3>' + \\$summary['Low'] + '</h3><p>Riesgo Bajo</p></div>' }
                                else { \\$html += '<div class=\"card card-safe\"><h3>0</h3><p>Riesgo Bajo</p></div>' }
                                
                                if(\\$summary['Informational']) { \\$html += '<div class=\"card card-info\"><h3>' + \\$summary['Informational'] + '</h3><p>Informacional</p></div>' }
                                else { \\$html += '<div class=\"card card-safe\"><h3>0</h3><p>Informacional</p></div>' }
                                
                                \\$html += @'
            </div>
        </div>
        
        <div class='alerts-section'>
            <h2>üîç Detalles de Alertas</h2>
'@
                                
                                foreach(\\$alert in \\$alerts) {
                                    \\$risk = \\$alert.riskdesc -split ' ' | Select-Object -First 1
                                    \\$riskClass = \\$risk.ToLower()
                                    if(\\$risk -eq 'Informational') { \\$riskClass = 'info' }
                                    
                                    \\$instances = \\$alert.instances.instance
                                    \\$instanceCount = if(\\$instances -is [array]) { \\$instances.Count } else { 1 }
                                    
                                    \\$html += @\\\"
            <div class='alert-item alert-\\$riskClass'>
                <div class='instances-count'>\\$instanceCount instancias</div>
                <div class='alert-title'>
                    \\$($alert.name)
                    <span class='risk-badge risk-\\$riskClass'>\\$risk</span>
                </div>
                <p><strong>Descripci√≥n:</strong> \\$($alert.desc)</p>
                
                <div class='alert-details'>
                    <div class='detail-item'>
                        <div class='detail-label'>URLs Afectadas:</div>
                        <div class='detail-value'>
\\\"@
                                    
                                    foreach(\\$instance in \\$instances) {
                                        \\$html += \\\"<div>‚Ä¢ \\$($instance.uri)</div>\\\"
                                    }
                                    
                                    \\$html += @\\\"
                        </div>
                    </div>
                    <div class='detail-item'>
                        <div class='detail-label'>Detalles T√©cnicos:</div>
                        <div class='detail-value'>
                            <div><strong>CWE ID:</strong> \\$($alert.cweid)</div>
                            <div><strong>WASC ID:</strong> \\$($alert.wascid)</div>
                        </div>
                    </div>
                </div>
                
                <div class='solution-box'>
                    <div class='solution-title'>üí° Soluci√≥n Recomendada:</div>
                    <div>\\$($alert.solution)</div>
                </div>
                
                <div class='reference-links'>
                    <strong>Referencias:</strong><br>
                    <a href='\\$($alert.reference)' target='_blank'>Documentaci√≥n T√©cnica</a>
                </div>
            </div>
\\\"@
                                }
                                
                                \\$html += @'
        </div>
    </div>
</body>
</html>
'@
                                
                                \\$html | Out-File -FilePath '${REPORTS_DIR}\\frontend-report.html' -Encoding UTF8
                                "
                            """
                            
                            echo "Frontend scan completado - reporte visual generado"
                            
                        } catch (Exception e) {
                            echo "Frontend scan con warnings: ${e.message}"
                            currentBuild.result = 'UNSTABLE'
                        }
                    }
                    
                    // Backend Scan - mismo proceso
                    if (env.BACKEND_OK == 'true') {
                        echo "Escaneando Backend..."
                        try {
                            timeout(time: 20, unit: 'MINUTES') {
                                bat "docker run --rm --network host -v \"%cd%\\${REPORTS_DIR}:/zap/wrk\" zaproxy/zap-stable zap-baseline.py -t ${BACKEND_URL} -x backend-raw.xml"
                            }
                            
                            // Convertir XML a HTML mejorado para backend
                            bat """
                                powershell -Command "
                                [xml]\\$xml = Get-Content '${REPORTS_DIR}\\backend-raw.xml'
                                \\$alerts = \\$xml.OWASPZAPReport.site.alerts.alertitem
                                \\$summary = @{}
                                foreach(\\$alert in \\$alerts) {
                                    \\$risk = \\$alert.riskdesc -split ' ' | Select-Object -First 1
                                    if(\\$summary.ContainsKey(\\$risk)) { \\$summary[\\$risk]++ } else { \\$summary[\\$risk] = 1 }
                                }
                                
                                # Mismo HTML template pero para backend
                                \\$html = @'
<!DOCTYPE html>
<html lang='es'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Backend Security Report - PRESTABANCO</title>
    <link rel='stylesheet' href='assets/enhanced-style.css'>
</head>
<body>
    <div class='container'>
        <div class='header'>
            <h1>‚öôÔ∏è Backend API Security Report</h1>
            <p>Target: ${BACKEND_URL}</p>
            <p>Generated: '+ (Get-Date).ToString('yyyy-MM-dd HH:mm:ss') +'</p>
            <a href='dashboard.html' class='nav-button'>‚Üê Volver al Dashboard</a>
        </div>
        
        <div class='summary-section'>
            <div style='background: #e8f4fd; border: 1px solid #007bff; border-radius: 8px; padding: 15px; margin-bottom: 20px;'>
                <strong>üîí Spring Security Detectado:</strong> Error 403 es normal e indica protecci√≥n activa
            </div>
            <h2>üìä Resumen de Alertas</h2>
            <div class='summary-cards'>
'@
                                
                                # Mismo c√≥digo de summary cards...
                                if(\\$summary['High']) { \\$html += '<div class=\"card card-high\"><h3>' + \\$summary['High'] + '</h3><p>Riesgo Alto</p></div>' }
                                else { \\$html += '<div class=\"card card-safe\"><h3>0</h3><p>Riesgo Alto</p></div>' }
                                
                                if(\\$summary['Medium']) { \\$html += '<div class=\"card card-medium\"><h3>' + \\$summary['Medium'] + '</h3><p>Riesgo Medio</p></div>' }
                                else { \\$html += '<div class=\"card card-safe\"><h3>0</h3><p>Riesgo Medio</p></div>' }
                                
                                if(\\$summary['Low']) { \\$html += '<div class=\"card card-low\"><h3>' + \\$summary['Low'] + '</h3><p>Riesgo Bajo</p></div>' }
                                else { \\$html += '<div class=\"card card-safe\"><h3>0</h3><p>Riesgo Bajo</p></div>' }
                                
                                if(\\$summary['Informational']) { \\$html += '<div class=\"card card-info\"><h3>' + \\$summary['Informational'] + '</h3><p>Informacional</p></div>' }
                                else { \\$html += '<div class=\"card card-safe\"><h3>0</h3><p>Informacional</p></div>' }
                                
                                # Resto igual que frontend pero con t√≠tulo Backend...
                                \\$html += '</div></div><div class=\"alerts-section\"><h2>üîç Detalles de Alertas</h2>'
                                
                                foreach(\\$alert in \\$alerts) {
                                    \\$risk = \\$alert.riskdesc -split ' ' | Select-Object -First 1
                                    \\$riskClass = \\$risk.ToLower()
                                    if(\\$risk -eq 'Informational') { \\$riskClass = 'info' }
                                    
                                    \\$instances = \\$alert.instances.instance
                                    \\$instanceCount = if(\\$instances -is [array]) { \\$instances.Count } else { 1 }
                                    
                                    \\$html += \\\"<div class='alert-item alert-\\$riskClass'><div class='instances-count'>\\$instanceCount instancias</div><div class='alert-title'>\\$($alert.name) <span class='risk-badge risk-\\$riskClass'>\\$risk</span></div><p><strong>Descripci√≥n:</strong> \\$($alert.desc)</p><div class='solution-box'><div class='solution-title'>üí° Soluci√≥n:</div><div>\\$($alert.solution)</div></div></div>\\\"
                                }
                                
                                \\$html += '</div></div></body></html>'
                                \\$html | Out-File -FilePath '${REPORTS_DIR}\\backend-report.html' -Encoding UTF8
                                "
                            """
                            
                            echo "Backend scan completado - reporte visual generado"
                            
                        } catch (Exception e) {
                            echo "Backend scan con warnings: ${e.message}"
                            currentBuild.result = 'UNSTABLE'
                        }
                    }
                    
                    // Crear dashboard principal
                    bat """
                        echo ^<!DOCTYPE html^> > ${REPORTS_DIR}\\dashboard.html
                        echo ^<html lang="es"^> >> ${REPORTS_DIR}\\dashboard.html
                        echo ^<head^> >> ${REPORTS_DIR}\\dashboard.html
                        echo     ^<meta charset="UTF-8"^> >> ${REPORTS_DIR}\\dashboard.html
                        echo     ^<meta name="viewport" content="width=device-width, initial-scale=1.0"^> >> ${REPORTS_DIR}\\dashboard.html
                        echo     ^<title^>PRESTABANCO Security Dashboard^</title^> >> ${REPORTS_DIR}\\dashboard.html
                        echo     ^<link rel="stylesheet" href="assets/enhanced-style.css"^> >> ${REPORTS_DIR}\\dashboard.html
                        echo ^</head^> >> ${REPORTS_DIR}\\dashboard.html
                        echo ^<body^> >> ${REPORTS_DIR}\\dashboard.html
                        echo     ^<div class="container"^> >> ${REPORTS_DIR}\\dashboard.html
                        echo         ^<div class="header"^> >> ${REPORTS_DIR}\\dashboard.html
                        echo             ^<h1^>üîí PRESTABANCO Security Dashboard^</h1^> >> ${REPORTS_DIR}\\dashboard.html
                        echo             ^<p^>An√°lisis de Seguridad Completo - Build ${BUILD_NUMBER}^</p^> >> ${REPORTS_DIR}\\dashboard.html
                        echo             ^<p^>%date% %time%^</p^> >> ${REPORTS_DIR}\\dashboard.html
                        echo         ^</div^> >> ${REPORTS_DIR}\\dashboard.html
                        echo         ^<div class="summary-section"^> >> ${REPORTS_DIR}\\dashboard.html
                        echo             ^<h2^>üìä Servicios Analizados^</h2^> >> ${REPORTS_DIR}\\dashboard.html
                        echo             ^<div class="summary-cards"^> >> ${REPORTS_DIR}\\dashboard.html
                        echo                 ^<div class="card ${env.FRONTEND_OK == 'true' ? 'card-safe' : 'card-medium'}"^> >> ${REPORTS_DIR}\\dashboard.html
                        echo                     ^<h3^>üåê^</h3^> >> ${REPORTS_DIR}\\dashboard.html
                        echo                     ^<p^>Frontend ${env.FRONTEND_OK == 'true' ? 'Escaneado' : 'No disponible'}^</p^> >> ${REPORTS_DIR}\\dashboard.html
                        echo                 ^</div^> >> ${REPORTS_DIR}\\dashboard.html
                        echo                 ^<div class="card ${env.BACKEND_OK == 'true' ? 'card-safe' : 'card-medium'}"^> >> ${REPORTS_DIR}\\dashboard.html
                        echo                     ^<h3^>‚öôÔ∏è^</h3^> >> ${REPORTS_DIR}\\dashboard.html
                        echo                     ^<p^>Backend ${env.BACKEND_OK == 'true' ? 'Escaneado' : 'No disponible'}^</p^> >> ${REPORTS_DIR}\\dashboard.html
                        echo                 ^</div^> >> ${REPORTS_DIR}\\dashboard.html
                        echo                 ^<div class="card card-safe"^> >> ${REPORTS_DIR}\\dashboard.html
                        echo                     ^<h3^>üõ°Ô∏è^</h3^> >> ${REPORTS_DIR}\\dashboard.html
                        echo                     ^<p^>Database Protegida^</p^> >> ${REPORTS_DIR}\\dashboard.html
                        echo                 ^</div^> >> ${REPORTS_DIR}\\dashboard.html
                        echo             ^</div^> >> ${REPORTS_DIR}\\dashboard.html
                        echo         ^</div^> >> ${REPORTS_DIR}\\dashboard.html
                        echo         ^<div style="padding: 40px; text-align: center;"^> >> ${REPORTS_DIR}\\dashboard.html
                        echo             ^<h2^>üìÑ Reportes Detallados^</h2^> >> ${REPORTS_DIR}\\dashboard.html
                        echo             ^<a href="frontend-report.html" class="nav-button"^>üåê Ver Reporte Frontend^</a^> >> ${REPORTS_DIR}\\dashboard.html
                        echo             ^<a href="backend-report.html" class="nav-button"^>‚öôÔ∏è Ver Reporte Backend^</a^> >> ${REPORTS_DIR}\\dashboard.html
                        echo             ^<a href="RESUMEN-SEGURIDAD.txt" class="nav-button"^>üìÑ Resumen T√©cnico^</a^> >> ${REPORTS_DIR}\\dashboard.html
                        echo         ^</div^> >> ${REPORTS_DIR}\\dashboard.html
                        echo     ^</div^> >> ${REPORTS_DIR}\\dashboard.html
                        echo ^</body^> >> ${REPORTS_DIR}\\dashboard.html
                        echo ^</html^> >> ${REPORTS_DIR}\\dashboard.html
                    """
                    
                    // Crear resumen t√©cnico
                    bat """
                        echo ===================================== > ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo    PRESTABANCO - SECURITY SCAN     >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo ===================================== >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo. >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo Fecha: %date% %time% >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo Build: ${BUILD_NUMBER} >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo. >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo ARCHIVOS GENERADOS (VERSION MEJORADA): >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo. >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo üè† dashboard.html (EMPEZAR AQUI) >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo    - Dashboard principal con navegacion >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo    - Resumen visual de todos los servicios >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo. >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo üåê frontend-report.html (REPORTE VISUAL MEJORADO) >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo    - Alertas organizadas por riesgo >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo    - Cards coloridos para cada vulnerabilidad >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo    - Soluciones destacadas visualmente >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo    - Enlaces a referencias t√©cnicas >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo. >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo ‚öôÔ∏è backend-report.html (REPORTE VISUAL MEJORADO) >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo    - Alertas organizadas por riesgo >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo    - Nota sobre Spring Security >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo    - Detalles t√©cnicos de cada vulnerabilidad >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo. >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo SERVICIOS ANALIZADOS: >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo   Frontend:  ${env.FRONTEND_OK} >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo   Backend:   ${env.BACKEND_OK} >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo   Database:  PROTEGIDA (configuracion correcta) >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo. >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo MEJORAS VISUALES INCLUIDAS: >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo ‚úì Dise√±o moderno con gradientes >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo ‚úì Cards coloridos por nivel de riesgo >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo ‚úì Alertas organizadas y f√°ciles de leer >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo ‚úì Soluciones destacadas en cajas verdes >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo ‚úì Contador de instancias por vulnerabilidad >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo ‚úì Referencias t√©cnicas como botones >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo ‚úì Responsive design para m√≥viles >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo ‚úì Navegaci√≥n fluida entre reportes >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo. >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo COMO USAR: >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo 1. Abrir dashboard.html en navegador >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo 2. Hacer clic en botones para ver reportes detallados >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo 3. Cada alerta tiene colores segun riesgo: >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo    - Rojo: Alto riesgo >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo    - Naranja: Riesgo medio >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo    - Amarillo: Riesgo bajo >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo    - Azul: Informacional >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo    - Verde: Sin problemas >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo. >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo ‚úÖ REPORTES VISUALES MEJORADOS GENERADOS >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                        echo üé® TODAS LAS ALERTAS ORGANIZADAS Y FACILES DE IDENTIFICAR >> ${REPORTS_DIR}\\RESUMEN-SEGURIDAD.txt
                    """
                    
                    currentBuild.result = 'SUCCESS'
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                script {
                    try {
                        bat '''
                            cd %cd%\\''' + "${REPORTS_DIR}" + '''
                            if exist *-raw.xml del *-raw.xml
                            if exist *.yaml del *.yaml
                            if exist *.yml del *.yml
                        '''
                        echo "Archivos temporales eliminados - reportes mejorados listos"
                    } catch (Exception e) {
                        echo "No hay archivos temporales para eliminar"
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                archiveArtifacts artifacts: "${REPORTS_DIR}/**", allowEmptyArchive: true
                
                echo """
                ==========================================
                   PRESTABANCO SECURITY REPORTS ENHANCED
                ==========================================
                
                üé® REPORTES VISUALES MEJORADOS GENERADOS:
                   üè† dashboard.html (DASHBOARD PRINCIPAL)
                   üåê frontend-report.html (alertas organizadas)
                   ‚öôÔ∏è backend-report.html (alertas organizadas)
                   üìÑ RESUMEN-SEGURIDAD.txt (gu√≠a t√©cnica)
                   üé® assets/enhanced-style.css (estilos modernos)
                
                üîó ACCESO: ${BUILD_URL}artifact/${REPORTS_DIR}/
                
                ‚ú® MEJORAS VISUALES:
                   - Cards coloridos por nivel de riesgo
                   - Alertas organizadas y f√°ciles de leer
                   - Soluciones destacadas en cajas verdes
                   - Contador de instancias por vulnerabilidad
                   - Referencias t√©cnicas como botones clickeables
                   - Dise√±o responsive para m√≥viles
                   - Navegaci√≥n fluida entre reportes
                   - Gradientes modernos y sombras
                
                üìñ COMO USAR:
                   1. Descargar security-reports.zip
                   2. Abrir dashboard.html en navegador
                   3. Navegar usando botones azules
                   4. Identificar alertas por colores:
                      üî¥ Alto riesgo | üü† Medio | üü° Bajo | üîµ Info
                
                üéØ SERVICIOS ANALIZADOS:
                   Frontend: ${env.FRONTEND_OK == 'true' ? 'ESCANEADO Y VISUALIZADO' : 'NO DISPONIBLE'}
                   Backend:  ${env.BACKEND_OK == 'true' ? 'ESCANEADO Y VISUALIZADO' : 'NO DISPONIBLE'}
                   Database: PROTEGIDA (configuraci√≥n segura)
                
                üèÜ RESULTADO: ALERTAS ORGANIZADAS VISUALMENTE
                ==========================================
                """
            }
        }
        success {
            echo "üéâ Security scan completado - reportes visuales mejorados generados!"
        }
        unstable {
            echo "‚ö†Ô∏è Scan completado con warnings - reportes visuales disponibles"
        }
        failure {
            echo "‚ùå Scan fall√≥ - revisar configuraci√≥n"
        }
    }
}