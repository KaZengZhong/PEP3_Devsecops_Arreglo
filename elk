pipeline {
    agent any
    
    parameters {
        choice(
            name: 'SCAN_DEPTH',
            choices: ['QUICK', 'STANDARD', 'COMPREHENSIVE'],
            description: 'Profundidad del escaneo de seguridad'
        )
        booleanParam(
            name: 'DEPLOY_ELK',
            defaultValue: true,
            description: 'Desplegar Elastic Stack'
        )
        booleanParam(
            name: 'SEND_TO_ELASTIC',
            defaultValue: true,
            description: 'Enviar resultados a Elasticsearch'
        )
    }
    
    environment {
        REPORTS_DIR = 'security-reports'
        ELK_DIR = 'elk-stack'
        FRONTEND_URL = 'http://localhost:8070'
        BACKEND_URL = 'http://localhost:8090'
        ELASTICSEARCH_URL = 'http://localhost:9200'
        KIBANA_URL = 'http://localhost:5601'
        ELASTIC_INDEX = 'prestabanco-security'
    }
    
    stages {
        stage('Initialize ELK Pipeline') {
            steps {
                script {
                    echo "=== PRESTABANCO SECURITY + ELASTIC STACK PIPELINE ==="
                    echo "Frontend: ${FRONTEND_URL}"
                    echo "Backend: ${BACKEND_URL}"
                    echo "Elasticsearch: ${ELASTICSEARCH_URL}"
                    echo "Kibana: ${KIBANA_URL}"
                    
                    bat """
                        if exist ${REPORTS_DIR} rmdir /s /q ${REPORTS_DIR}
                        if exist ${ELK_DIR} rmdir /s /q ${ELK_DIR}
                        mkdir ${REPORTS_DIR}
                        mkdir ${ELK_DIR}
                        mkdir ${ELK_DIR}\\config
                        mkdir ${ELK_DIR}\\data
                    """
                }
            }
        }
        
        stage('Setup Elastic Stack Configuration') {
            when {
                expression { params.DEPLOY_ELK == true }
            }
            steps {
                script {
                    echo "Configurando Elastic Stack..."
                    
                    // Crear docker-compose para ELK
                    bat """
                        echo version: '3.8' > ${ELK_DIR}\\docker-compose-elk.yml
                        echo services: >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo   elasticsearch: >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo     image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0 >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo     container_name: elasticsearch >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo     environment: >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo       - discovery.type=single-node >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo       - xpack.security.enabled=false >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo       - xpack.security.enrollment.enabled=false >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo       - "ES_JAVA_OPTS=-Xms1g -Xmx1g" >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo     ports: >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo       - "9200:9200" >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo       - "9300:9300" >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo     volumes: >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo       - elasticsearch_data:/usr/share/elasticsearch/data >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo     networks: >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo       - elk >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo. >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo   kibana: >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo     image: docker.elastic.co/kibana/kibana:8.11.0 >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo     container_name: kibana >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo     environment: >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo       - ELASTICSEARCH_HOSTS=http://elasticsearch:9200 >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo       - xpack.security.enabled=false >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo       - xpack.encryptedSavedObjects.encryptionKey=fhjskloppd678ehkdfdlliverpoolfcr >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo     ports: >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo       - "5601:5601" >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo     depends_on: >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo       - elasticsearch >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo     networks: >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo       - elk >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo. >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo networks: >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo   elk: >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo     driver: bridge >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo. >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo volumes: >> ${ELK_DIR}\\docker-compose-elk.yml
                        echo   elasticsearch_data: >> ${ELK_DIR}\\docker-compose-elk.yml
                    """
                }
            }
        }
        
        stage('Deploy Elastic Stack') {
            when {
                expression { params.DEPLOY_ELK == true }
            }
            steps {
                script {
                    echo "Desplegando Elastic Stack..."
                    try {
                        bat 'cd ' + ELK_DIR + ' && docker-compose -f docker-compose-elk.yml down || echo "No ELK containers to stop"'
                        bat 'cd ' + ELK_DIR + ' && docker-compose -f docker-compose-elk.yml up -d'
                        
                        echo "Esperando que Elasticsearch inicie..."
                        sleep(time: 120, unit: 'SECONDS')
                        
                        // Verificar que Elasticsearch esté corriendo
                        timeout(time: 5, unit: 'MINUTES') {
                            waitUntil {
                                script {
                                    try {
                                        bat 'curl -f ' + ELASTICSEARCH_URL + '/_cluster/health'
                                        return true
                                    } catch (Exception e) {
                                        echo "Esperando Elasticsearch..."
                                        return false
                                    }
                                }
                            }
                        }
                        
                        echo "Elasticsearch iniciado correctamente"
                        
                    } catch (Exception e) {
                        echo "Warning: ELK deployment issue: ${e.message}"
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }
        
        stage('Deploy PrestaBanco Services') {
            steps {
                script {
                    echo "Desplegando servicios PrestaBanco..."
                    bat 'docker-compose -f compose2.yml down || echo "No containers to stop"'
                    bat 'docker-compose -f compose2.yml up -d'
                    sleep(time: 90, unit: 'SECONDS')
                }
            }
        }
        
        stage('Verify All Services') {
            steps {
                script {
                    def frontendOk = false
                    def backendOk = false
                    def elasticOk = false
                    def kibanaOk = false
                    
                    echo "Verificando todos los servicios..."
                    bat 'docker ps --format "table {{.Names}}\\t{{.Ports}}\\t{{.Status}}"'
                    
                    // Verificar Frontend
                    try {
                        bat 'powershell -Command "Invoke-WebRequest -Uri http://localhost:8070 -TimeoutSec 10 -UseBasicParsing | Out-Null"'
                        frontendOk = true
                        echo "Frontend: OK"
                    } catch (Exception e) {
                        echo "Frontend: FAILED"
                    }
                    
                    // Verificar Backend
                    try {
                        bat 'powershell -Command "Test-NetConnection -ComputerName localhost -Port 8090 -WarningAction SilentlyContinue"'
                        backendOk = true
                        echo "Backend: OK"
                    } catch (Exception e) {
                        echo "Backend: FAILED"
                    }
                    
                    // Verificar Elasticsearch
                    if (params.DEPLOY_ELK) {
                        try {
                            bat 'curl -f ' + ELASTICSEARCH_URL + '/_cluster/health'
                            elasticOk = true
                            echo "Elasticsearch: OK"
                        } catch (Exception e) {
                            echo "Elasticsearch: FAILED"
                        }
                        
                        // Verificar Kibana
                        try {
                            bat 'powershell -Command "Test-NetConnection -ComputerName localhost -Port 5601 -WarningAction SilentlyContinue"'
                            kibanaOk = true
                            echo "Kibana: OK"
                        } catch (Exception e) {
                            echo "Kibana: FAILED"
                        }
                    }
                    
                    env.FRONTEND_OK = frontendOk.toString()
                    env.BACKEND_OK = backendOk.toString()
                    env.ELASTIC_OK = elasticOk.toString()
                    env.KIBANA_OK = kibanaOk.toString()
                }
            }
        }
        
        stage('Security Scan with ELK Integration') {
            steps {
                script {
                    echo "Ejecutando scans de seguridad con integración ELK..."
                    
                    // Frontend Scan
                    if (env.FRONTEND_OK == 'true') {
                        echo "Escaneando Frontend..."
                        try {
                            timeout(time: 20, unit: 'MINUTES') {
                                bat "docker run --rm --network host -v \"%cd%\\${REPORTS_DIR}:/zap/wrk\" zaproxy/zap-stable zap-baseline.py -t ${FRONTEND_URL} -J frontend-report.json -x frontend-report.xml -r frontend-report.html"
                            }
                            echo "Frontend scan completado"
                        } catch (Exception e) {
                            echo "Frontend scan con warnings: ${e.message}"
                            currentBuild.result = 'UNSTABLE'
                        }
                    }
                    
                    // Backend Scan
                    if (env.BACKEND_OK == 'true') {
                        echo "Escaneando Backend..."
                        try {
                            timeout(time: 20, unit: 'MINUTES') {
                                bat "docker run --rm --network host -v \"%cd%\\${REPORTS_DIR}:/zap/wrk\" zaproxy/zap-stable zap-baseline.py -t ${BACKEND_URL} -J backend-report.json -x backend-report.xml -r backend-report.html"
                            }
                            echo "Backend scan completado"
                        } catch (Exception e) {
                            echo "Backend scan con warnings: ${e.message}"
                            currentBuild.result = 'UNSTABLE'
                        }
                    }
                }
            }
        }
        
        stage('Process and Send to Elasticsearch') {
            when {
                allOf {
                    expression { params.SEND_TO_ELASTIC == true }
                    expression { env.ELASTIC_OK == 'true' }
                }
            }
            steps {
                script {
                    echo "Procesando reportes para Elasticsearch..."
                    
                    try {
                        // Crear índice en Elasticsearch
                        bat 'curl -X PUT "' + ELASTICSEARCH_URL + '/' + ELASTIC_INDEX + '-template" -H "Content-Type: application/json"'
                        
                        // Procesar y enviar datos de frontend
                        if (env.FRONTEND_OK == 'true') {
                            bat """
                                powershell -Command "
                                if (Test-Path '${REPORTS_DIR}\\frontend-report.json') {
                                    try {
                                        \\$data = Get-Content '${REPORTS_DIR}\\frontend-report.json' | ConvertFrom-Json
                                        if (\\$data.site.alerts) {
                                            foreach (\\$alert in \\$data.site.alerts) {
                                                \\$doc = @{
                                                    timestamp = (Get-Date).ToString('yyyy-MM-ddTHH:mm:ss.fffZ')
                                                    project = 'prestabanco'
                                                    scan_type = 'frontend_security'
                                                    build_number = '${BUILD_NUMBER}'
                                                    alert_name = \\$alert.name
                                                    risk_level = \\$alert.riskdesc
                                                    target_url = '${FRONTEND_URL}'
                                                }
                                                \\$json = \\$doc | ConvertTo-Json -Compress
                                                try {
                                                    Invoke-RestMethod -Uri '${ELASTICSEARCH_URL}/${ELASTIC_INDEX}-frontend/_doc' -Method POST -Body \\$json -ContentType 'application/json'
                                                } catch {
                                                    Write-Host 'Error sending to Elasticsearch: ' \\$_.Exception.Message
                                                }
                                            }
                                        }
                                    } catch {
                                        Write-Host 'Error processing frontend JSON: ' \\$_.Exception.Message
                                    }
                                }
                                "
                            """
                        }
                        
                        // Procesar y enviar datos de backend
                        if (env.BACKEND_OK == 'true') {
                            bat """
                                powershell -Command "
                                if (Test-Path '${REPORTS_DIR}\\backend-report.json') {
                                    try {
                                        \\$data = Get-Content '${REPORTS_DIR}\\backend-report.json' | ConvertFrom-Json
                                        if (\\$data.site.alerts) {
                                            foreach (\\$alert in \\$data.site.alerts) {
                                                \\$doc = @{
                                                    timestamp = (Get-Date).ToString('yyyy-MM-ddTHH:mm:ss.fffZ')
                                                    project = 'prestabanco'
                                                    scan_type = 'backend_security'
                                                    build_number = '${BUILD_NUMBER}'
                                                    alert_name = \\$alert.name
                                                    risk_level = \\$alert.riskdesc
                                                    target_url = '${BACKEND_URL}'
                                                }
                                                \\$json = \\$doc | ConvertTo-Json -Compress
                                                try {
                                                    Invoke-RestMethod -Uri '${ELASTICSEARCH_URL}/${ELASTIC_INDEX}-backend/_doc' -Method POST -Body \\$json -ContentType 'application/json'
                                                } catch {
                                                    Write-Host 'Error sending to Elasticsearch: ' \\$_.Exception.Message
                                                }
                                            }
                                        }
                                    } catch {
                                        Write-Host 'Error processing backend JSON: ' \\$_.Exception.Message
                                    }
                                }
                                "
                            """
                        }
                        
                        echo "Datos enviados a Elasticsearch"
                        
                    } catch (Exception e) {
                        echo "Warning enviando datos a Elasticsearch: ${e.message}"
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }
        
        stage('Setup Kibana') {
            when {
                allOf {
                    expression { params.DEPLOY_ELK == true }
                    expression { env.KIBANA_OK == 'true' }
                }
            }
            steps {
                script {
                    echo "Configurando Kibana..."
                    
                    try {
                        sleep(time: 60, unit: 'SECONDS')
                        
                        // Crear index pattern básico
                        bat 'curl -X POST "' + KIBANA_URL + '/api/saved_objects/index-pattern/' + ELASTIC_INDEX + '-*" -H "Content-Type: application/json" -H "kbn-xsrf: true"'
                        
                        echo "Kibana configurado"
                        
                    } catch (Exception e) {
                        echo "Warning configurando Kibana: ${e.message}"
                    }
                }
            }
        }
        
        stage('Generate Reports') {
            steps {
                script {
                    echo "Generando reportes finales..."
                    
                    bat """
                        echo ========================================== > ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo    PRESTABANCO + ELASTIC STACK REPORT    >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo ========================================== >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo. >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo Fecha: %date% %time% >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo Build: ${BUILD_NUMBER} >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo. >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo SERVICIOS DESPLEGADOS: >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo Frontend:      ${env.FRONTEND_OK == 'true' ? 'ACTIVO' : 'INACTIVO'} - ${FRONTEND_URL} >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo Backend:       ${env.BACKEND_OK == 'true' ? 'ACTIVO' : 'INACTIVO'} - ${BACKEND_URL} >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo Elasticsearch: ${env.ELASTIC_OK == 'true' ? 'ACTIVO' : 'INACTIVO'} - ${ELASTICSEARCH_URL} >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo Kibana:        ${env.KIBANA_OK == 'true' ? 'ACTIVO' : 'INACTIVO'} - ${KIBANA_URL} >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo. >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo ACCESO DIRECTO: >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo Kibana Dashboard: ${KIBANA_URL} >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo Elasticsearch API: ${ELASTICSEARCH_URL} >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo Index Pattern: ${ELASTIC_INDEX}-* >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo. >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo ARCHIVOS GENERADOS: >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo frontend-report.html >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo backend-report.html >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo frontend-report.json (enviado a ELK) >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo backend-report.json (enviado a ELK) >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo. >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo COMO USAR KIBANA: >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo 1. Abrir ${KIBANA_URL} >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo 2. Ir a Discover >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo 3. Seleccionar index ${ELASTIC_INDEX}-* >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo 4. Explorar datos de seguridad >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo. >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                        echo PIPELINE ELK COMPLETADO >> ${REPORTS_DIR}\\REPORTE-ELK.txt
                    """
                }
            }
        }
    }
    
    post {
        always {
            script {
                archiveArtifacts artifacts: "${REPORTS_DIR}/**", allowEmptyArchive: true
                archiveArtifacts artifacts: "${ELK_DIR}/**", allowEmptyArchive: true
                
                echo """
                ===============================================
                   PRESTABANCO + ELASTIC STACK COMPLETED
                ===============================================
                
                SERVICIOS:
                   Frontend:      ${env.FRONTEND_OK == 'true' ? 'ACTIVO' : 'INACTIVO'} - ${FRONTEND_URL}
                   Backend:       ${env.BACKEND_OK == 'true' ? 'ACTIVO' : 'INACTIVO'} - ${BACKEND_URL}
                   Elasticsearch: ${env.ELASTIC_OK == 'true' ? 'ACTIVO' : 'INACTIVO'} - ${ELASTICSEARCH_URL}
                   Kibana:        ${env.KIBANA_OK == 'true' ? 'ACTIVO' : 'INACTIVO'} - ${KIBANA_URL}
                
                ACCESO:
                   Kibana: ${KIBANA_URL}
                   Reportes: ${BUILD_URL}artifact/${REPORTS_DIR}/
                
                PRÓXIMOS PASOS:
                   1. Abrir Kibana
                   2. Ir a Discover
                   3. Explorar index: ${ELASTIC_INDEX}-*
                ===============================================
                """
            }
        }
        success {
            echo "Pipeline ELK completado exitosamente!"
        }
        unstable {
            echo "Pipeline completado con warnings"
        }
        failure {
            echo "Pipeline falló - revisar logs"
        }
    }
}