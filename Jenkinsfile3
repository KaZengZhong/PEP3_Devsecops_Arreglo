pipeline {
    agent any
    
    environment {
        REPORTS_DIR = 'security-reports'
        TIMESTAMP = "${new Date().format('yyyyMMdd-HHmmss')}"
        COMPOSE_FILE = 'compose2.yml'
    }
    
    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }
        
        stage('Preparation') {
            steps {
                script {
                    // Crear directorio para reportes
                    bat "if not exist %REPORTS_DIR% mkdir %REPORTS_DIR%"
                    
                    echo "=== PIPELINE DE SEGURIDAD OWASP ZAP ==="
                    echo "ğŸ³ Desplegando aplicaciones automÃ¡ticamente"
                    echo "ğŸ•·ï¸ AnÃ¡lisis dinÃ¡mico completo con OWASP ZAP"
                }
            }
        }

        // ========== DESPLIEGUE AUTOMÃTICO ==========
        stage('Deploy Applications') {
            steps {
                script {
                    echo "ğŸ³ Desplegando aplicaciones con Docker Compose..."
                    
                    // Verificar que Docker Compose estÃ© disponible
                    bat '''
                        docker --version
                        docker-compose --version
                    '''
                    
                    // Verificar que el archivo compose2.yml existe
                    bat '''
                        if exist %COMPOSE_FILE% (
                            echo "âœ… Docker Compose file found: %COMPOSE_FILE%"
                        ) else (
                            echo "âŒ Docker Compose file NOT found: %COMPOSE_FILE%"
                            exit 1
                        )
                    '''
                    
                    // Limpiar contenedores anteriores
                    bat '''
                        echo "ğŸ§¹ Cleaning up previous containers..."
                        docker-compose -f %COMPOSE_FILE% down --remove-orphans || echo "No previous containers to remove"
                    '''
                    
                    // Levantar servicios con logs detallados
                    bat '''
                        echo "ğŸš€ Starting services with Docker Compose..."
                        docker-compose -f %COMPOSE_FILE% up -d
                    '''
                    
                    // Verificar que los containers se levantaron
                    bat '''
                        echo "ğŸ“Š Checking container status..."
                        docker-compose -f %COMPOSE_FILE% ps
                        
                        echo "ğŸ“‹ Container logs preview:"
                        docker-compose -f %COMPOSE_FILE% logs --tail=10
                    '''
                    
                    echo "â³ Services deployed, waiting for readiness..."
                }
            }
        }
        
        stage('Wait for Applications Ready') {
            steps {
                script {
                    echo "ğŸ” Verificando que las aplicaciones estÃ©n listas..."
                    
                    // Esperar que los containers estÃ©n running (comando compatible con Windows)
                    bat '''
                        echo "Waiting for containers to be fully ready..."
                        ping localhost -n 31 > nul
                    '''
                    
                    // Verificar estado de containers
                    bat '''
                        echo "Checking container status..."
                        docker-compose -f %COMPOSE_FILE% ps
                    '''
                    
                    // Verificar frontend con reintentos
                    script {
                        def frontendReady = false
                        for (int i = 0; i < 5; i++) {
                            def result = bat(script: 'curl -f http://localhost:8070', returnStatus: true)
                            if (result == 0) {
                                frontendReady = true
                                echo "âœ… Frontend is ready!"
                                break
                            } else {
                                echo "Frontend not ready yet, attempt ${i+1}/5"
                                bat 'ping localhost -n 11 > nul'  // Wait 10 seconds
                            }
                        }
                        if (!frontendReady) {
                            echo "âš ï¸ Frontend not responding after 5 attempts"
                        }
                    }
                    
                    // Verificar backend con reintentos
                    script {
                        def backendReady = false
                        for (int i = 0; i < 5; i++) {
                            def result = bat(script: 'curl -f http://localhost:8090/actuator/health', returnStatus: true)
                            if (result == 0) {
                                backendReady = true
                                echo "âœ… Backend is ready!"
                                break
                            } else {
                                echo "Backend not ready yet, attempt ${i+1}/5"
                                bat 'ping localhost -n 11 > nul'  // Wait 10 seconds
                            }
                        }
                        if (!backendReady) {
                            echo "âš ï¸ Backend not responding after 5 attempts"
                        }
                    }
                    
                    echo "ğŸ” Continuing with security scans..."
                }
            }
        }

        // ========== OWASP ZAP SECURITY SCANS ==========
        stage('OWASP ZAP Baseline Scans') {
            parallel {
                stage('ZAP Baseline - Frontend') {
                    steps {
                        script {
                            echo "ğŸ•·ï¸ OWASP ZAP - Baseline Scan Frontend..."
                            
                            bat '''
                                docker run --rm ^
                                    -v "%cd%\\%REPORTS_DIR%:/zap/wrk/:rw" ^
                                    --network host ^
                                    -t zaproxy/zap-stable ^
                                    zap-baseline.py ^
                                    -t http://localhost:8070 ^
                                    -J zap-frontend-baseline-%TIMESTAMP%.json ^
                                    -r zap-frontend-baseline-%TIMESTAMP%.html ^
                                    -x zap-frontend-baseline-%TIMESTAMP%.xml ^
                                    --auto
                                exit /b 0
                            '''
                        }
                    }
                }
                
                stage('ZAP Baseline - Backend') {
                    steps {
                        script {
                            echo "ğŸ•·ï¸ OWASP ZAP - Baseline Scan Backend..."
                            
                            bat '''
                                docker run --rm ^
                                    -v "%cd%\\%REPORTS_DIR%:/zap/wrk/:rw" ^
                                    --network host ^
                                    -t zaproxy/zap-stable ^
                                    zap-baseline.py ^
                                    -t http://localhost:8090 ^
                                    -J zap-backend-baseline-%TIMESTAMP%.json ^
                                    -r zap-backend-baseline-%TIMESTAMP%.html ^
                                    -x zap-backend-baseline-%TIMESTAMP%.xml ^
                                    --auto
                                exit /b 0
                            '''
                        }
                    }
                }
            }
        }
        
        stage('OWASP ZAP API Scan') {
            steps {
                script {
                    echo "ğŸ•·ï¸ OWASP ZAP - API Security Scan..."
                    
                    bat '''
                        docker run --rm ^
                            -v "%cd%\\%REPORTS_DIR%:/zap/wrk/:rw" ^
                            --network host ^
                            -t zaproxy/zap-stable ^
                            zap-api-scan.py ^
                            -t http://localhost:8090/v3/api-docs ^
                            -f openapi ^
                            -J zap-api-scan-%TIMESTAMP%.json ^
                            -r zap-api-scan-%TIMESTAMP%.html ^
                            -x zap-api-scan-%TIMESTAMP%.xml || echo "API scan completed"
                        exit /b 0
                    '''
                }
            }
        }

        // ========== OWASP ZAP FULL SCANS ==========
        stage('OWASP ZAP Full Scans') {
            parallel {
                stage('ZAP Full Scan - Frontend') {
                    steps {
                        script {
                            echo "ğŸ•·ï¸ OWASP ZAP - Full Scan Frontend (anÃ¡lisis profundo)..."
                            
                            bat '''
                                docker run --rm ^
                                    -v "%cd%\\%REPORTS_DIR%:/zap/wrk/:rw" ^
                                    --network host ^
                                    -t zaproxy/zap-stable ^
                                    zap-full-scan.py ^
                                    -t http://localhost:8070 ^
                                    -J zap-full-frontend-%TIMESTAMP%.json ^
                                    -r zap-full-frontend-%TIMESTAMP%.html ^
                                    -x zap-full-frontend-%TIMESTAMP%.xml ^
                                    --auto
                                exit /b 0
                            '''
                        }
                    }
                }
                
                stage('ZAP Full Scan - Backend') {
                    steps {
                        script {
                            echo "ğŸ•·ï¸ OWASP ZAP - Full Scan Backend (anÃ¡lisis profundo)..."
                            
                            bat '''
                                docker run --rm ^
                                    -v "%cd%\\%REPORTS_DIR%:/zap/wrk/:rw" ^
                                    --network host ^
                                    -t zaproxy/zap-stable ^
                                    zap-full-scan.py ^
                                    -t http://localhost:8090 ^
                                    -J zap-full-backend-%TIMESTAMP%.json ^
                                    -r zap-full-backend-%TIMESTAMP%.html ^
                                    -x zap-full-backend-%TIMESTAMP%.xml ^
                                    --auto
                                exit /b 0
                            '''
                        }
                    }
                }
            }
        }

        // ========== ANÃLISIS DE RESULTADOS ==========
        stage('Security Analysis & Reports') {
            steps {
                script {
                    echo "ğŸ“Š Generando anÃ¡lisis consolidado de vulnerabilidades..."
                    
                    // Listar todos los reportes
                    bat "dir %REPORTS_DIR%"
                    
                    // Crear resumen de seguridad OWASP ZAP
                    bat '''
                        echo === RESUMEN DE SEGURIDAD OWASP ZAP === > "%REPORTS_DIR%/zap-security-summary-%TIMESTAMP%.txt"
                        echo Fecha: %DATE% %TIME% >> "%REPORTS_DIR%/zap-security-summary-%TIMESTAMP%.txt"
                        echo Pipeline: Docker Compose + OWASP ZAP >> "%REPORTS_DIR%/zap-security-summary-%TIMESTAMP%.txt"
                        echo. >> "%REPORTS_DIR%/zap-security-summary-%TIMESTAMP%.txt"
                        echo Scans ejecutados: >> "%REPORTS_DIR%/zap-security-summary-%TIMESTAMP%.txt"
                        echo - ZAP Baseline Frontend >> "%REPORTS_DIR%/zap-security-summary-%TIMESTAMP%.txt"
                        echo - ZAP Baseline Backend >> "%REPORTS_DIR%/zap-security-summary-%TIMESTAMP%.txt"
                        echo - ZAP API Scan Backend >> "%REPORTS_DIR%/zap-security-summary-%TIMESTAMP%.txt"
                        echo - ZAP Full Scan Frontend >> "%REPORTS_DIR%/zap-security-summary-%TIMESTAMP%.txt"
                        echo - ZAP Full Scan Backend >> "%REPORTS_DIR%/zap-security-summary-%TIMESTAMP%.txt"
                        echo. >> "%REPORTS_DIR%/zap-security-summary-%TIMESTAMP%.txt"
                        echo Reportes generados: >> "%REPORTS_DIR%/zap-security-summary-%TIMESTAMP%.txt"
                        dir /b "%REPORTS_DIR%" >> "%REPORTS_DIR%/zap-security-summary-%TIMESTAMP%.txt"
                    '''
                    
                    echo "âœ… AnÃ¡lisis completo de seguridad OWASP ZAP finalizado"
                    echo "ğŸ“Š Tipos de reportes: JSON, HTML, XML"
                    echo "ğŸ” Vulnerabilidades detectadas en aplicaciones web"
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "ğŸ§¹ Limpiando recursos..."
                
                // Bajar containers
                bat '''
                    docker-compose -f %COMPOSE_FILE% down --remove-orphans || echo "Cleanup completed"
                '''
                
                echo "ğŸ“ Archivando reportes de seguridad OWASP ZAP..."
                archiveArtifacts artifacts: "${REPORTS_DIR}/**/*", allowEmptyArchive: true
                
                echo "ğŸ¯ PIPELINE OWASP ZAP COMPLETADO"
                echo "ğŸ“Š Reportes disponibles en Jenkins artifacts"
                echo "ğŸ•·ï¸ AnÃ¡lisis dinÃ¡mico de seguridad web completo"
            }
        }
        
        success {
            echo "âœ… Pipeline OWASP ZAP ejecutado exitosamente"
            echo "ğŸ” Revisa los reportes HTML para ver vulnerabilidades detalladas"
        }
        
        failure {
            echo "âŒ Pipeline fallÃ³ - revisar logs para detalles"
            echo "ğŸ’¡ Tip: Las aplicaciones deben estar disponibles para el escaneo"
        }
    }
}