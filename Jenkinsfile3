pipeline {
    agent any
    
    environment {
        REPORTS_DIR = 'security-reports'
        COMPOSE_FILE = 'compose2.yml'
    }
    
    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }
        
        stage('Preparation') {
            steps {
                script {
                    // Crear directorio para reportes
                    bat "if not exist %REPORTS_DIR% mkdir %REPORTS_DIR%"
                    
                    echo "=== PIPELINE DE SEGURIDAD OWASP ZAP ==="
                    echo "üê≥ Desplegando aplicaciones autom√°ticamente"
                    echo "üï∑Ô∏è An√°lisis din√°mico completo con OWASP ZAP"
                }
            }
        }

        // ========== DESPLIEGUE AUTOM√ÅTICO ==========
        stage('Deploy Applications') {
            steps {
                script {
                    echo "üê≥ Desplegando aplicaciones con Docker Compose..."
                    
                    // Verificar que Docker Compose est√© disponible
                    bat '''
                        docker --version
                        docker-compose --version
                    '''
                    
                    // Verificar que el archivo compose2.yml existe
                    bat '''
                        if exist %COMPOSE_FILE% (
                            echo "‚úÖ Docker Compose file found: %COMPOSE_FILE%"
                        ) else (
                            echo "‚ùå Docker Compose file NOT found: %COMPOSE_FILE%"
                            exit 1
                        )
                    '''
                    
                    // Limpiar contenedores anteriores
                    bat '''
                        echo "üßπ Cleaning up previous containers..."
                        docker-compose -f %COMPOSE_FILE% down --remove-orphans || echo "No previous containers to remove"
                    '''
                    
                    // Levantar servicios con logs detallados
                    bat '''
                        echo "üöÄ Starting services with Docker Compose..."
                        docker-compose -f %COMPOSE_FILE% up -d
                    '''
                    
                    // Verificar que los containers se levantaron
                    bat '''
                        echo "üìä Checking container status..."
                        docker-compose -f %COMPOSE_FILE% ps
                        
                        echo "üìã Container logs preview:"
                        docker-compose -f %COMPOSE_FILE% logs --tail=10
                    '''
                    
                    echo "‚è≥ Services deployed, waiting for readiness..."
                }
            }
        }
        
        stage('Wait for Applications Ready') {
            steps {
                script {
                    echo "üîç Verificando que las aplicaciones est√©n listas..."
                    
                    // Esperar que los containers est√©n running (comando compatible con Windows)
                    bat '''
                        echo "Waiting for containers to be fully ready..."
                        ping localhost -n 31 > nul
                    '''
                    
                    // Verificar estado de containers
                    bat '''
                        echo "Checking container status..."
                        docker-compose -f %COMPOSE_FILE% ps
                    '''
                    
                    // Verificar frontend con reintentos
                    script {
                        def frontendReady = false
                        for (int i = 0; i < 5; i++) {
                            def result = bat(script: 'curl -f http://localhost:8070', returnStatus: true)
                            if (result == 0) {
                                frontendReady = true
                                echo "‚úÖ Frontend is ready!"
                                break
                            } else {
                                echo "Frontend not ready yet, attempt ${i+1}/5"
                                bat 'ping localhost -n 11 > nul'  // Wait 10 seconds
                            }
                        }
                        if (!frontendReady) {
                            echo "‚ö†Ô∏è Frontend not responding after 5 attempts"
                        }
                    }
                    
                    // Verificar backend con reintentos
                    script {
                        def backendReady = false
                        for (int i = 0; i < 5; i++) {
                            def result = bat(script: 'curl -f http://localhost:8090/actuator/health', returnStatus: true)
                            if (result == 0) {
                                backendReady = true
                                echo "‚úÖ Backend is ready!"
                                break
                            } else {
                                echo "Backend not ready yet, attempt ${i+1}/5"
                                bat 'ping localhost -n 11 > nul'  // Wait 10 seconds
                            }
                        }
                        if (!backendReady) {
                            echo "‚ö†Ô∏è Backend not responding after 5 attempts"
                        }
                    }
                    
                    echo "üîç Continuing with security scans..."
                }
            }
        }

        stage('OWASP ZAP Baseline Scans') {
            parallel {
                stage('ZAP Baseline - Frontend') {
                    steps {
                        script {
                            echo "üï∑Ô∏è OWASP ZAP - Baseline Scan Frontend..."
                            
                            bat '''
                                docker run --rm ^
                                    -v "%cd%\\%REPORTS_DIR%:/zap/wrk/:rw" ^
                                    --network host ^
                                    -t zaproxy/zap-stable ^
                                    zap-baseline.py ^
                                    -t http://localhost:8070 ^
                                    -J zap-frontend-baseline.json ^
                                    -r zap-frontend-baseline.html ^
                                    -x zap-frontend-baseline.xml ^
                                    --auto
                                exit /b 0
                            '''
                        }
                    }
                }
                
                stage('ZAP Baseline - Backend') {
                    steps {
                        script {
                            echo "üï∑Ô∏è OWASP ZAP - Baseline Scan Backend..."
                            
                            bat '''
                                docker run --rm ^
                                    -v "%cd%\\%REPORTS_DIR%:/zap/wrk/:rw" ^
                                    --network host ^
                                    -t zaproxy/zap-stable ^
                                    zap-baseline.py ^
                                    -t http://localhost:8090 ^
                                    -J zap-backend-baseline.json ^
                                    -r zap-backend-baseline.html ^
                                    -x zap-backend-baseline.xml ^
                                    --auto
                                exit /b 0
                            '''
                        }
                    }
                }
            }
        }
        
        stage('OWASP ZAP API Scan') {
            steps {
                script {
                    echo "üï∑Ô∏è OWASP ZAP - API Security Scan..."
                    
                    bat '''
                        docker run --rm ^
                            -v "%cd%\\%REPORTS_DIR%:/zap/wrk/:rw" ^
                            --network host ^
                            -t zaproxy/zap-stable ^
                            zap-api-scan.py ^
                            -t http://localhost:8090/v3/api-docs ^
                            -f openapi ^
                            -J zap-api-scan.json ^
                            -r zap-api-scan.html ^
                            -x zap-api-scan.xml || echo "API scan completed"
                        exit /b 0
                    '''
                }
            }
        }

        // ========== OWASP ZAP FULL SCANS (OPCIONAL) ==========
        stage('OWASP ZAP Full Scan - Frontend') {
            steps {
                script {
                    echo "üï∑Ô∏è OWASP ZAP - Full Scan Frontend (an√°lisis profundo)..."
                    
                    bat '''
                        docker run --rm ^
                            -v "%cd%\\%REPORTS_DIR%:/zap/wrk/:rw" ^
                            --network host ^
                            -t zaproxy/zap-stable ^
                            zap-full-scan.py ^
                            -t http://localhost:8070 ^
                            -J zap-full-frontend.json ^
                            -r zap-full-frontend.html ^
                            -x zap-full-frontend.xml ^
                            --auto
                        exit /b 0
                    '''
                }
            }
        }

        // ========== AN√ÅLISIS DE RESULTADOS ==========
        stage('Vulnerability Summary') {
            steps {
                script {
                    echo "üìä Generando resumen de vulnerabilidades..."
                    
                    // Resumen simple sin timestamps
                    bat '''
                        echo === RESUMEN DE SEGURIDAD OWASP ZAP === > "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo Fecha: %DATE% %TIME% >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo Pipeline: OWASP ZAP Security Scan >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo. >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo === SCANS EJECUTADOS === >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo ‚úÖ ZAP Baseline Frontend >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo ‚úÖ ZAP Baseline Backend >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo ‚úÖ ZAP API Scan Backend >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo ‚úÖ ZAP Full Scan Frontend >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo. >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo === ARCHIVOS PRINCIPALES PARA REVISAR === >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo üìã SECURITY-SUMMARY.txt: Este archivo (instrucciones) >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo üåê zap-frontend-baseline.html: Vulnerabilidades Frontend >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo üåê zap-backend-baseline.html: Vulnerabilidades Backend >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo üåê zap-api-scan.html: Vulnerabilidades API REST >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo üåê zap-full-frontend.html: An√°lisis profundo Frontend >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo. >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo === COMO REVISAR === >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo 1. Descarga los archivos .HTML desde Jenkins Build Artifacts >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo 2. Abre cada archivo .HTML en tu navegador web >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo 3. Busca la seccion "ALERTS" para ver vulnerabilidades >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo 4. Prioriza: HIGH ^> MEDIUM ^> LOW ^> INFO >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo 5. Lee las recomendaciones de cada vulnerabilidad >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo. >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        echo === TODOS LOS ARCHIVOS === >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                        dir /b "%REPORTS_DIR%" >> "%REPORTS_DIR%/SECURITY-SUMMARY.txt"
                    '''
                    
                    echo "üìä Resumen de seguridad generado: SECURITY-SUMMARY.txt"
                }
            }
        }
        
        stage('Security Analysis & Reports') {
            steps {
                script {
                    echo "üìä Generando an√°lisis consolidado de vulnerabilidades..."
                    
                    // Listar todos los reportes
                    bat "dir %REPORTS_DIR%"
                    
                    // Contar archivos de reportes
                    def reportCount = bat(script: 'dir /b "%REPORTS_DIR%" | find /c ".html"', returnStdout: true).trim()
                    
                    echo "‚úÖ An√°lisis completo de seguridad OWASP ZAP finalizado"
                    echo "üìä Tipos de reportes: JSON (datos), HTML (visual), XML (integraci√≥n)"
                    echo "üîç ${reportCount} reportes HTML generados para revisi√≥n"
                    echo "üìÅ ARCHIVO PRINCIPAL: SECURITY-SUMMARY.txt"
                    echo "üåê ARCHIVOS CLAVE: zap-frontend-baseline.html, zap-backend-baseline.html"
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "üßπ Limpiando recursos..."
                
                // Bajar containers
                bat '''
                    docker-compose -f %COMPOSE_FILE% down --remove-orphans || echo "Cleanup completed"
                '''
                
                echo "üìÅ Archivando reportes de seguridad OWASP ZAP..."
                archiveArtifacts artifacts: "${REPORTS_DIR}/**/*", allowEmptyArchive: true
                
                // Publicar reportes HTML como links accesibles
                publishHTML([
                    allowMissing: false,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: "${REPORTS_DIR}",
                    reportFiles: "*.html",
                    reportName: "OWASP ZAP Security Reports",
                    reportTitles: "Security Vulnerability Reports"
                ])
                
                echo "üéØ PIPELINE OWASP ZAP COMPLETADO"
                echo "üìä Reportes disponibles en Jenkins artifacts"
                echo "üåê Reportes HTML accesibles desde Jenkins UI"
                echo "üï∑Ô∏è An√°lisis din√°mico de seguridad web completo"
            }
        }
        
        success {
            echo "‚úÖ Pipeline OWASP ZAP ejecutado exitosamente"
            echo "üîç Revisa los reportes HTML para ver vulnerabilidades detalladas"
            echo "üìã Archivo SECURITY-SUMMARY.txt contiene instrucciones completas"
        }
        
        failure {
            echo "‚ùå Pipeline fall√≥ - revisar logs para detalles"
            echo "üí° Tip: Las aplicaciones deben estar disponibles para el escaneo"
        }
    }
}